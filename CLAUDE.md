# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Marinara is a Chrome extension that implements the Pomodoro Technique for time management. It's built with Vue.js 2, uses Chrome extension APIs, and follows an observer pattern architecture.

## Build Commands

**Development:**
```bash
npm run dev        # Watch mode - builds to package/modules/
npm run serve      # Dev server (for component development)
make dev           # Alias for npm run dev
```

**Production:**
```bash
npm run build      # Production build to package/modules/
make release       # Build and create Chrome extension .zip package
```

**Testing:**
```bash
npm run test:unit  # Run Mocha unit tests
make test          # Alias for unit tests
```

**Release Process:**
See RELEASE.md for the full release workflow. Key steps:
1. Bump version in **both** `package/manifest.json` (Chrome extension version) and `package.json` (npm version)
2. Run tests: `make test`
3. Create package: `make release`
4. The extension package is created using Ruby scripts in the `scripts/` directory

## Architecture

### Multi-Page Chrome Extension Structure

The extension consists of three separate Vue.js pages built by vue-cli-service (configured in `vue.config.js`):

1. **Background Page** (`src/background/main.js`): Persistent background script that manages the core timer logic, observers, and services
2. **Options Page** (`src/options/main.js`): Full-featured settings/stats UI with Vue Router
3. **Countdown Page** (`src/countdown/main.js`): Timer countdown display
4. **Expire Page** (`src/expire/main.js`): Timer expiration notification page

All pages compile to `package/modules/` and are referenced in `package/manifest.json`.

### Core Timer System

**PomodoroTimer** (`src/background/Timer.js`):
- Central timer state machine managing three phases: Focus, ShortBreak, LongBreak
- Extends EventEmitter and follows the Observer pattern
- Emits events: `start`, `stop`, `pause`, `resume`, `tick`, `expire`
- Tracks pomodoro count and automatically cycles between phases
- Configuration comes from PersistentSettings

**Timer** (base class in same file):
- Lower-level countdown timer managing elapsed/remaining time
- Handles checkpointing for pause/resume functionality
- Uses setTimeout/setInterval for timing (not Chrome alarms during active timers)

### Observer Pattern

The background page (`src/background/main.js`) registers multiple observers on the PomodoroTimer:

- **BadgeObserver**: Updates browser action badge with timer state
- **NotificationObserver**: Shows desktop/tab notifications
- **HistoryObserver**: Records completed pomodoros
- **TimerSoundObserver**: Plays ticking sounds during focus
- **ExpirationSoundObserver**: Plays sound when timer expires
- **CountdownObserver**: Manages countdown window display
- **MenuObserver**: Updates context menu based on timer state
- **ApiSyncObserver**: Syncs pomodoro data to external API (vercel.app endpoint)

Observers implement methods like `onStart()`, `onStop()`, `onExpire()`, etc. and are registered via `timer.observe(observer)`.

### Service Architecture

**ServiceBroker** (`src/Service.js`):
- Enables RPC-style communication between extension contexts (background, options page, etc.)
- Uses Chrome message passing under the hood
- Services registered in background page: HistoryService, SettingsService, PomodoroService, SoundsService, OptionsService
- Other pages use Service proxies (e.g., `HistoryClient.once.getStats()`) to call background services

**Key Services** (`src/background/Services.js`):
- **PomodoroService**: Exposes timer control methods and re-emits timer events
- **SettingsService**: Manages persistent settings via StorageManager
- **HistoryService**: Provides access to pomodoro history and stats

### Settings Management

**PersistentSettings** (`src/background/Settings.js`):
- Wraps StorageManager with reactive settings
- Schema versioning with migration support (currently v7)
- Settings stored in Chrome sync storage
- Three phase configs: focus, shortBreak, longBreak
- Each phase has: duration, timerSound, countdown, notifications

**StorageManager** (`src/background/StorageManager.js`):
- Manages schema migrations when settings version changes
- Emits 'change' events when settings update

### Internationalization

**Messages System**:
- Source: `package/_locales/en/messages.json` (and other locale files)
- Generated: `src/Messages.js` is auto-generated by `scripts/create-messages.rb`
- Run `make messages` to regenerate after editing locale files
- Always validate with `ruby -Iscripts scripts/validate-messages.rb` before building

## Vue.js Configuration

**CSP Restrictions** (`vue.config.js`):
- Chrome extension CSP prohibits eval and inline scripts
- Uses `inline-source-map` for devtool (not eval)
- `runtimeCompiler: false` - must use template pre-compilation
- CSS is embedded in JS modules (not extracted to separate files)

**File Naming**:
- Consistent naming between dev and prod: `[name].js` (no hashing)
- Chunks: `chunk-vendors.js`, `chunk-common.js`
- In dev mode, chunks are "touched" to ensure they exist even if empty

## Chrome Extension Specifics

**Manifest v2** (`package/manifest.json`):
- Requires minimum Chrome 55
- Persistent background page (not event page)
- Permissions: alarms, contextMenus, storage, notifications
- External API permission: `https://*.vercel.app/*`

**Alarms** (`src/background/Alarms.js`):
- Used for scheduled autostart feature (not for active timer ticking)
- Chrome alarms have 1-minute minimum, unsuitable for countdown ticking

**SingletonPage** (`src/background/SingletonPage.js`):
- Utility for managing single-instance pages (options, countdown)
- Can be hosted in tabs or windows

## Testing

**Unit Tests** (`tests/unit/`):
- Framework: Mocha + Chai
- Located in `tests/unit/`
- Key test files: `timer.spec.js`, `history.spec.js`
- Use `@/` alias for `src/` imports (configured by vue-cli)

**Testing PomodoroTimer**:
- Mock settings object with phase durations
- Use async/await with timer events: `await timer.expired()` pattern
- Test phase transitions and pomodoro counting

## Common Patterns

**Async/Await for Race Conditions**:
Prefer async/await patterns over setTimeout for handling race conditions (per user's CLAUDE.md preference).

**Mutex for Audio** (`src/Mutex.js`):
Used in TimerSoundObserver to prevent race conditions when starting/stopping timer sounds.

**EventEmitter**:
Most core classes extend Node.js EventEmitter for pub/sub patterns.

## Development Tools

**Ruby Dependencies**:
- System `ruby` and `make` required for build scripts
- `jq` required for manifest manipulation: `brew install jq`

**Testing Locales**:
```bash
make run             # Run Chrome with extension loaded
make run-loc         # Run under different locale
make run-pseudo      # Run with pseudo-localized messages
```

## Key Files to Know

- `src/background/Timer.js` - Core timer state machine
- `src/background/main.js` - Background page entry, observer setup
- `src/background/Observers.js` - All timer observers
- `src/Service.js` - RPC service architecture
- `src/background/Services.js` - Service implementations
- `src/background/Settings.js` - Settings schema and persistence
- `vue.config.js` - Multi-page build configuration
- `package/manifest.json` - Chrome extension manifest

## Audio System

**Timer Sounds** (`src/TimerSound.js`):
- Two types: Metronome (generated tones) and White Noise
- Uses Web Audio API via Metronome and Noise classes
- Managed by TimerSoundObserver

**Notification Sounds** (`src/Sounds.js`):
- MP3/OGG files in package/audio/
- Played via ExpirationSoundObserver
